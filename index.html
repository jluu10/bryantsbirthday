<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>yorknew city birthday route</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --sky:#aee3ff; --sky-2:#86d7ff; --sand:#f5e9d2;
      --ink:#111827; --card:#fffdf8; --accent:#4aa3ff;
      --ring:rgba(74,163,255,.45); --shadow:rgba(0,0,0,.12);
      --chibi-size:84px; /* tweak 72–100px */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:linear-gradient(180deg,var(--sky) 0%,var(--sky-2) 50%,var(--sand) 100%);
      font-family:'Press Start 2P', ui-monospace, Menlo, Consolas, monospace
    }

    header.hero{ text-align:center; padding:1.25rem .8rem .4rem }
    header.hero h1{ margin:.2rem 0; font-size:clamp(1.1rem,2.6vw,1.6rem) }
    header.hero .sub{ color:#233; opacity:.9; font-size:.8rem }

    .scene{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:1rem; z-index:30 }
    .scene.active{ display:flex }
    .modal{ width:min(740px,100%); background:var(--card); border:4px solid #e8dcc6; border-radius:12px; padding:1rem; box-shadow:0 20px 60px var(--shadow); text-align:center }
    .row{ display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.6rem; justify-content:center }
    .btn{ background:var(--accent); color:#fff; border:none; padding:.75rem 1rem; border-radius:10px; box-shadow:0 6px 0 #2b79c5; cursor:pointer }
    .btn.secondary{ background:#ffe7c9; color:#50381d; box-shadow:0 6px 0 #d7b38a }
    .btn:focus{ outline:2px solid var(--ring); outline-offset:2px }

    /* narrator dialog */
    .narrator-layer{ position:fixed; inset:0; z-index:28; display:none }
    .narrator-layer.show{ display:grid; place-items:center }
    .speech{ position:relative; margin:0 auto; background:var(--card); border:4px solid #e8dcc6; border-radius:12px; padding:1.1rem 1.1rem 1rem; width:min(780px,92vw); box-shadow:0 20px 60px var(--shadow); text-align:left }
    .speech .txt{ line-height:1.6; font-size:.9rem; font-variant-ligatures:none; font-feature-settings:"liga" 0, "kern" 0; font-kerning:none; -webkit-font-smoothing:antialiased; text-rendering:geometricPrecision }
    .speech .txt.typing{ font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; letter-spacing:0 }
    .speech .who{ display:block; color:#7c6b55; font-size:.75rem; margin-bottom:.25rem }
    .speech.has-chibi-left{ padding-left: calc(var(--chibi-size) + 22px); }

    /* CHIBI overlay */
    #chibiHead{ position:fixed; width:var(--chibi-size); height:var(--chibi-size); z-index:60; pointer-events:none; filter:drop-shadow(0 10px 16px rgba(0,0,0,.25)); animation:bob 2.1s ease-in-out infinite; display:none }
    #chibiHead img{ width:100%; height:auto; display:block; image-rendering:pixelated }
    #chibiHead.wave img{ animation:wave 900ms ease-in-out 1 }
    @keyframes bob{ 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-6px) } }
    @keyframes wave{ 0%{ rotate:0 } 25%{ rotate:-6deg } 60%{ rotate:4deg } 100%{ rotate:0 } }

    #tapHint{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.72); color:#fff; padding:.55rem .9rem; border-radius:10px; font-size:.7rem; z-index:29; display:none }
    #tapHint.show{ display:block }

    /* retro grid */
    body::before{ content:""; position:fixed; inset:0; background-size:32px 32px; background-image: linear-gradient(to right, rgba(0,0,0,.15) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,.15) 1px, transparent 1px); pointer-events:none; z-index:0 }

    /* itinerary readable system font */
    main, .entry, .widget, .tabs button, .day h3, .meta, .result, textarea, small, input{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; letter-spacing:0; line-height:1.45 }

    main{ position:relative; padding: 0 1rem 2.4rem; max-width:1000px; margin:0 auto; z-index:1 }
    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap; margin:1rem 0; justify-content:center }
    .tabs button{ background:#e9f6ff; color:#174260; border:none; padding:.6rem .8rem; border-radius:10px; cursor:pointer; box-shadow:0 4px 0 #badcf4 }
    .tabs button[aria-selected="true"]{ background:#ffe7c9; color:#50381d; box-shadow:0 4px 0 #d7b38a }
    .card{ background:var(--card); border-radius:12px; border:4px solid #e8dcc6; box-shadow:0 12px 24px var(--shadow) }
    .day{ margin:1rem 0; padding:.9rem }
    .entry{ display:grid; grid-template-columns:1fr auto; gap:.6rem; border:1px dashed #ead9ba; border-radius:10px; padding:.7rem; margin:.6rem 0 }
    .entry .meta{ color:#7c6b55; font-size:.9rem }
    .entry a{ color:#0b66b2; text-decoration:none }

    /* widgets layout (2-up on desktop since Vinyl is gone) */
    .widgets{ display:grid; grid-template-columns:1fr; gap:1rem }
    @media(min-width:720px){ .widgets{ grid-template-columns:repeat(2,1fr) } }
    .widget{ padding:1rem }

    footer .bar{ display:flex; justify-content:flex-end; align-items:center; gap:1rem; padding:0 1rem 2rem; max-width:1000px; margin:0 auto }

    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:10 }

    /* hype scene */
    #scene2{ background:url('yorknew1.png') center/cover no-repeat }
    #scene2 .modal{ background:rgba(255,255,255,0.85) }

    /* === Nailong (retro sprite vibe) === */
    .emote-frame{ margin-top:.6rem; display:flex; flex-direction:column; align-items:center; gap:.35rem }
    .emote-img{
      max-width:100%; border:4px solid #e8dcc6; border-radius:10px; background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.25); image-rendering:pixelated;
    }
    .emote-img.flip{ animation:flipIn .45s ease-out }
    @keyframes flipIn{
      0%{ transform:rotateY(90deg); opacity:0 }
      50%{ transform:rotateY(10deg); opacity:.6 }
      100%{ transform:rotateY(0); opacity:1 }
    }
    .emote-img.glitch{ animation:glitchPix .2s steps(2,end) 1 }
    @keyframes glitchPix{
      0%{ filter:contrast(200%) saturate(150%) hue-rotate(20deg) }
      50%{ filter:contrast(300%) saturate(200%) hue-rotate(-20deg) }
      100%{ filter:none }
    }
  </style>
</head>
<body>
  <header class="hero">
    <h1>yorknew city story route</h1>
    <p class="sub">trip starts in <span id="countdown">—</span></p>
  </header>

  <!-- Scene 1: Start -->
  <section id="scene1" class="scene active">
    <div class="modal">
      <h2>hello bb! 🎉</h2>
      <p id="bd-line" style="font-size:.8rem">It is your birthday in <strong id="bd-count">—</strong>, and you know what that means…</p>
      <div class="row">
        <button id="btn-what" class="btn">what does it mean?!?</button>
        <button id="btn-know" class="btn secondary">i know what that means :D</button>
      </div>
    </div>
  </section>

  <!-- Scene 1.5: Sassy "girl bffr" loop -->
  <section id="sceneSassy" class="scene">
    <div class="modal">
      <h2>girl bffr 😭</h2>
      <p style="font-size:.8rem;color:#5b4630">(click anywhere)</p>
    </div>
  </section>

  <!-- Scene 2: Hype -->
  <section id="scene2" class="scene">
    <div class="modal">
      <h2 style="font-size:clamp(1.6rem,5vw,2.6rem); margin:.2rem 0 .4rem">YORKNEW CITY RAHHHHH🗽💥</h2>
      <p style="font-size:.8rem; color:#5b4630">click anywhere to continue…</p>
    </div>
  </section>

  <!-- Scene 2.5: Love Quiz -->
  <section id="sceneQuiz" class="scene">
    <div class="modal">
      <h2>but first, an important question…</h2>
      <p style="margin:.4rem 0 1rem">who do i love?</p>
      <div style="display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap">
        <input id="quizInput" type="text" placeholder="type your answer" style="font-size:14px;padding:.6rem .8rem;border:2px dashed #ead9ba;border-radius:10px;min-width:220px" />
        <button id="quizBtn" class="btn">Submit</button>
      </div>
      <div id="quizErr" style="color:#b00020; margin-top:.6rem; min-height:1.2rem; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial"></div>
    </div>
  </section>

  <!-- Scene 2.6: Love Message -->
  <section id="sceneLove" class="scene">
    <div class="modal">
      <h2>Yes, you! 💖</h2>
      <p style="max-width:640px;margin:0 auto 0.6rem; line-height:1.5; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial">
        I love Bryant Giang. I am so happy to have the opportunity to celebrate your birthday and that you chose to spend it with me. I hope you enjoy the rest of your gift and can’t wait to celebrate many more with you, my lovely Bryant :3
      </p>
      <p style="font-size:.8rem;color:#5b4630">(click anywhere to continue)</p>
    </div>
  </section>

  <!-- Narrator dialog -->
  <div id="narrator" class="narrator-layer">
    <div id="speech" class="speech">
      <div class="txt"><span class="who">your girlfriend</span><div id="speechTxt">Loading…</div></div>
    </div>
  </div>

  <!-- chibi overlay (inline-left during story; peeks under itinerary after) -->
  <div id="chibiHead" aria-hidden="true">
    <img id="chibiImg" src="gfchibi.png" alt="Chibi" />
  </div>

  <div id="tapHint">click anywhere to continue →</div>

  <main id="app" hidden>
    <nav id="dayTabs" class="tabs" role="tablist" aria-label="Itinerary days"></nav>
    <section id="days"></section>

    <!-- Two widgets (Vinyl removed): Nailong + Notes -->
    <section class="widgets">
      <article class="widget card" id="nailongWidget">
        <h3>🟡 Nailong</h3>
        <p>Click to hit an emote.</p>
        <div class="emote-frame">
          <img id="emoteImg" alt="Nailong emote" class="emote-img" style="display:none" />
          <div id="emoteCaption" class="result" style="margin-top:.25rem"></div>
        </div>
        <button id="emoteBtn" class="btn" style="margin-top:.6rem">hit an emote</button>
      </article>

      <article class="widget card">
        <h3>💌 Little Notes</h3>
        <textarea id="noteArea" placeholder="Leave a sweet note here…" style="width:100%;min-height:160px;border:2px dashed #ead9ba;border-radius:10px;padding:.6rem .8rem"></textarea>
        <button id="saveNote" class="btn" style="margin-top:.6rem">Save</button>
        <small id="noteSaved" role="status" style="font-size:.75rem"></small>
      </article>
    </section>
  </main>

  <footer>
    <div class="bar">
      <a id="exportJSON" download="itinerary.json" href="#">Export plan JSON</a>
    </div>
  </footer>

  <canvas id="confetti" aria-hidden="true"></canvas>

  <script>
    /* ===== Trip Data ===== */
    const trip = {
      startDate: "2025-10-02",
      birthday:  "2025-10-03",
      days: [
        { label: "Day 1 · Thu", date: "2025-10-02", items:[
          { time:"Morning",   title:"Land & Drop Bags",        desc:"Drop bags and head to FLUSHING!", link:"https://maps.app.goo.gl/RNf8tJnhVzJcTk6S8", notes:"Caffeine @ Càphê Đen + Offepeak" },
          { time:"Afternoon", title:"Flushing Food Crawl",     desc:"We start our NYC adventure munchin’ + dilly-dallying.", link:"https://maps.app.goo.gl/dThBuXjiSDyp7B3G9", notes:"Eight Jane, Shanghai You Garden, Tesso…" },
          { time:"Afternoon", title:"Restore XP",              desc:"We buy some essentials and head home to rest :P", link:"https://maps.app.goo.gl/f114LiXaM1GEB7cB7", notes:"~45 min train ride" },
          { time:"Evening",   title:"NYC Clichés (Optional)",  desc:"Bike Central Park or visit the Met!", link:"https://maps.app.goo.gl/LzjBw7LhppjEbR6ZA", notes:"xoxo gossip girl" },
          { time:"Evening",   title:"Din Din",                 desc:"Dinner @ Kaia Wine Bar", link:"https://maps.app.goo.gl/7y5X9TmsRNpLuEUP9", notes:"South African tapas + HH" },
          { time:"Night",     title:"Piano Bars (Optional)",   desc:"Casual bars to mellow out the night", link:"https://maps.app.goo.gl/y5DxLZhxn3oTtvP48" },
          { time:"Night",     title:"Head Home",               desc:"Go home and slump", link:"https://maps.app.goo.gl/y5DxLZhxn3oTtvP48", notes:"Roosevelt Island Tram = pretty lights" }
        ]},
        { label: "Day 2 · Fri · 🎂 Birthday", date: "2025-10-03", items:[
          { time:"Morning", title:"Slow morning walk", desc:"Stroll a park or waterfront boardwalk.", link:"#"},
          { time:"Dinner",  title:"Omakase → Pizza & Vinyl", desc:"Chef’s counter; then slice + vinyl lounge.", link:"#", notes:"Bring ID for vinyl bar."},
          { time:"Late",    title:"Rooftop Nightcap", desc:"City lights & photos.", link:"#"}
        ]},
        { label: "Day 3 · Sat", date: "2025-10-04", items:[
          { time:"Daytime", title:"Neighborhood stroll + thrift", desc:"Williamsburg or LES; vintage browse.", link:"#"},
          { time:"Evening", title:"Showtime", desc:"Pick a concert/comedy based on mood.", link:"#"}
        ]},
        { label: "Day 4 · Sun", date: "2025-10-05", items:[
          { time:"Morning", title:"Museum or gallery hop", desc:"Choose 1–2 spots; keep it light.", link:"#"},
          { time:"Evening", title:"Sunset walk & dessert", desc:"Pier photos + sweet treat.", link:"#"}
        ]},
        { label: "Day 5 · Mon", date: "2025-10-06", items:[
          { time:"Morning", title:"Bonus day", desc:"One more NYC stroll, coffee & park.", link:"#"},
          { time:"Afternoon", title:"Last bites & souvenirs", desc:"Pick up gifts and head to airport.", link:"#"}
        ]}
      ]
    };

    /* ===== Helpers & Refs ===== */
    const $ = (q,root=document)=>root.querySelector(q);

    const countdownEl = $('#countdown');
    const scene1=$('#scene1'), scene2=$('#scene2');
    const sceneSassy=$('#sceneSassy');
    const sceneQuiz=$('#sceneQuiz');
    const sceneLove=$('#sceneLove');

    const bdCount=$('#bd-count');
    const btnWhat=$('#btn-what'), btnKnow=$('#btn-know');
    const narrator=$('#narrator');
    const speech=$('#speech');
    const speechTxt=$('#speechTxt');
    const chibiHead=$('#chibiHead');
    const tapHint=$('#tapHint');

    const app=$('#app');
    const dayTabs=$('#dayTabs');
    const daysWrap=$('#days');

    const noteArea=$('#noteArea'), saveNote=$('#saveNote'), noteSaved=$('#noteSaved');
    const exportJSON=$('#exportJSON');

    const quizInput=$('#quizInput');
    const quizBtn=$('#quizBtn');
    const quizErr=$('#quizErr');

    /* ===== Countdown ===== */
    function fmtTwo(n){return String(n).padStart(2,'0')}
    function humanCountdown(to){ const now=new Date(); const t=new Date(to); let ms=t-now; if(ms<0) ms=0; const d=Math.floor(ms/86400000); ms%=86400000; const h=Math.floor(ms/3600000); ms%=3600000; const m=Math.floor(ms/60000); ms%=60000; const s=Math.floor(ms/1000); return `${d}d ${fmtTwo(h)}h:${fmtTwo(m)}m:${fmtTwo(s)}s`; }
    function daysUntil(start){ const t=new Date(start+"T00:00:00"); const now=new Date(); const d=Math.ceil((t-now)/86400000); return d>=0?`${d} day${d===1?'':'s'}`:`${Math.abs(d)} day${Math.abs(d)===1?'':'s'} ago`; }
    function tickCountdown(){ countdownEl.textContent = daysUntil(trip.startDate); bdCount.textContent = humanCountdown(`${trip.birthday}T00:00:00`); }
    tickCountdown(); setInterval(tickCountdown,1000);

    /* ===== Story flow ===== */
    const lines = [
      "…what will we be doing in NYC, you may ask?",
      "Well, I coded a tiny retro adventure to reveal our plan.",
      "Follow me! We'll open the itinerary together."
    ];
    let li = -1; let isTyping = false; let storyDone = false;

    // Button 1 -> Sassy scene -> click anywhere returns to start
    btnWhat.addEventListener('click', ()=>{ scene1.classList.remove('active'); sceneSassy.classList.add('active'); });
    sceneSassy.addEventListener('click', ()=>{ sceneSassy.classList.remove('active'); scene1.classList.add('active'); });

    // Button 2 -> Hype scene
    btnKnow.addEventListener('click', ()=>{ scene1.classList.remove('active'); scene2.classList.add('active'); confetti(160); });

    // After hype -> Quiz
    scene2.addEventListener('click', ()=>{ scene2.classList.remove('active'); sceneQuiz.classList.add('active'); setTimeout(()=>quizInput.focus(), 50); });

    // Quiz handling
    function norm(s){ return (s||'').toLowerCase().trim(); }
    function isCorrect(ans){
      const a = norm(ans);
      return a === 'me' || a === 'bryant' || a === 'bryant giang' || a === 'anh' || /\bbryant\b/.test(a) || /\bme\b/.test(a) || /\banh\b/.test(a);
    }
    function submitQuiz(){
      const v = quizInput.value;
      if(isCorrect(v)){
        quizErr.textContent='';
        sceneQuiz.classList.remove('active');
        sceneLove.classList.add('active');
      }else{
        quizErr.textContent = 'mm nope… try again 🙂';
      }
    }
    quizBtn.addEventListener('click', submitQuiz);
    quizInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitQuiz(); }});

    // After love message -> start narration
    sceneLove.addEventListener('click', ()=>{ sceneLove.classList.remove('active'); startNarration(); });

    async function startNarration(){
      try{
        if(document.fonts && document.fonts.ready) await document.fonts.ready;
        narrator.classList.add('show');
        speech.classList.add('has-chibi-left'); // text padding so it doesn't collide
        chibiHead.style.display='block';
        anchorChibiInlineLeft(); // place inside the dialog box next to the label
        say(lines[++li]);
      }catch(e){ console.error(e); }
    }

    function typeText(el, text, cb){
      if(isTyping) return; isTyping=true;
      el.classList.add('typing'); el.textContent=''; let i=0;
      const step=()=>{
        el.textContent += (text[i++]||'');
        if(i<=text.length){ requestAnimationFrame(step) }
        else { el.classList.remove('typing'); isTyping=false; cb&&cb() }
      };
      requestAnimationFrame(step);
    }
    function say(text){
      typeText(speechTxt, text, ()=>{
        tapHint.classList.add('show');
        chibiHead.classList.add('wave');
        setTimeout(()=>chibiHead.classList.remove('wave'), 900);
      });
    }

    document.addEventListener('click', ()=>{
      if(!narrator.classList.contains('show')) return;
      if(isTyping) return;
      tapHint.classList.remove('show');
      li++;
      if(li<lines.length){ say(lines[li]) } else { narrator.classList.remove('show'); openApp() }
    });

    // Place chibi slightly inside the speech box, aligned with the header "your girlfriend"
    function anchorChibiInlineLeft(){
      const r = speech.getBoundingClientRect();
      const size = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--chibi-size')) || 84;
      const margin = 10;
      const left = r.left + margin;
      const top  = r.top + margin;
      chibiHead.style.left = Math.max(8, left) + 'px';
      chibiHead.style.top  = Math.max(8, top)  + 'px';
    }

    // After story: peek from under the itinerary (bottom-left inside container)
    function dockChibiPeekUnderItin(){
      const r = app.getBoundingClientRect();
      const size = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--chibi-size')) || 84;
      const visible = 0.55;
      const left = r.left + 8;
      const top  = r.bottom - size * visible;
      chibiHead.style.left = Math.max(8, left) + 'px';
      chibiHead.style.top  = Math.min(window.innerHeight - size/3, top) + 'px';
    }

    window.addEventListener('resize', ()=>{
      if(!storyDone && narrator.classList.contains('show')){ anchorChibiInlineLeft(); }
      else if(storyDone){ dockChibiPeekUnderItin(); }
    });

    function openApp(){ storyDone = true; app.hidden=false; renderDays(); confetti(120); dockChibiPeekUnderItin(); }

    /* ===== Itinerary ===== */
    function renderDays(){
      dayTabs.innerHTML='';
      trip.days.forEach((d,i)=>{
        const b=document.createElement('button');
        b.textContent=d.label; b.setAttribute('role','tab'); b.setAttribute('aria-selected', i===0?'true':'false');
        b.addEventListener('click',()=>{
          document.querySelectorAll('.tabs button').forEach(el=>el.setAttribute('aria-selected','false'));
          b.setAttribute('aria-selected','true'); renderDay(i);
        });
        dayTabs.appendChild(b);
      });
      renderDay(0);
    }
    function renderDay(i){
      const d=trip.days[i];
      const wrap=document.createElement('section'); wrap.className='card day';
      wrap.innerHTML=`<h3 style="margin:.2rem 0 .4rem">${d.label} <span style="font-weight:400;color:#7c6b55">${d.date}</span></h3>`;
      d.items.forEach(item=>{
        const e=document.createElement('article'); e.className='entry';
        e.innerHTML=`<div>
            <div style="font-size:.95rem; font-weight:600">${item.title}</div>
            <div class="meta">${item.time}</div>
            <p style="margin:.2rem 0 0">${item.desc||''}${item.notes? ' — <em>'+item.notes+'</em>':''}</p>
          </div>
          <div>${item.link? `<a href="${item.link}" target="_blank" rel="noopener">Open map/site ↗</a>`:''}</div>`;
        wrap.appendChild(e);
      });
      daysWrap.innerHTML=''; daysWrap.appendChild(wrap);
    }

    // Notes
    const NOTE_KEY='nyc_itin_note';
    noteArea.value=localStorage.getItem(NOTE_KEY)||'';
    saveNote.addEventListener('click',()=>{ localStorage.setItem(NOTE_KEY,noteArea.value); noteSaved.textContent='Saved ✓'; setTimeout(()=>noteSaved.textContent='',1200) });

    // Export JSON
    exportJSON.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(trip,null,2)],{type:'application/json'}); exportJSON.href=URL.createObjectURL(blob) });

    /* ===== Nailong Emote Spinner ===== */
    const EMOTE_SOURCES = [
      "IMG_0502.JPG",
      "IMG_0501.JPG",
      "IMG_0500.jpg",
      "IMG_0499.jpg",
      "IMG_0498.JPG",
      "IMG_0497.jpg",
      "IMG_0496.JPG",
      "IMG_0495.JPG",
      "IMG_0144.PNG"
    ];
    const EMOTE_CAPTIONS = [
      "serious side-eye",
      "unimpressed king",
      "hands on head!!",
      "uhh… hi?",
      "half-asleep vibes",
      "skeptical stare",
      "angy bonk mark",
      "moody night walk",
      "victory dance!"
    ];
    const emoteBtn = document.getElementById("emoteBtn");
    const emoteImg = document.getElementById("emoteImg");
    const emoteCaption = document.getElementById("emoteCaption");
    let lastEmote = -1;
    function showEmote(){
      if(!EMOTE_SOURCES.length) return;
      let i; do { i = Math.floor(Math.random()*EMOTE_SOURCES.length); } while(i===lastEmote && EMOTE_SOURCES.length>1);
      lastEmote = i;
      emoteImg.src = EMOTE_SOURCES[i];
      emoteImg.style.display = "block";
      emoteImg.classList.remove("flip","glitch"); void emoteImg.offsetWidth;
      emoteImg.classList.add("flip","glitch");
      emoteCaption.textContent = EMOTE_CAPTIONS[i] || "";
      confetti(40);
    }
    emoteBtn.addEventListener("click", showEmote);
    emoteImg.addEventListener("click", showEmote);

    /* ===== Confetti ===== */
    const cvs=document.getElementById('confetti'); const ctx=cvs.getContext('2d'); let pf=[];
    function size(){ cvs.width=innerWidth; cvs.height=innerHeight } window.addEventListener('resize',size); size();
    function confetti(N=100){ const colors=['#4aa3ff','#86d7ff','#ffbf7f','#f5e9d2','#ffffff']; for(let i=0;i<N;i++){ pf.push({x:innerWidth/2,y:80,vx:(Math.random()*2-1)*4,vy:-(2+Math.random()*3),g:.06+Math.random()*.04,s:2+Math.random()*3,c:colors[(Math.random()*colors.length)|0],t:100+Math.random()*80}) } }
    (function tick(){ ctx.clearRect(0,0,cvs.width,cvs.height); pf.forEach(p=>{ p.t--; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,p.s,p.s) }); pf=pf.filter(p=>p.t>0&&p.y<cvs.height+16); requestAnimationFrame(tick) })();

    /* ===== Self-tests ===== */
    (function selfTests(){
      try{
        console.assert(document.getElementById('bd-count'), '#bd-count exists');
        console.assert(document.getElementById('nailongWidget'), 'Nailong widget present');
      }catch(e){ console.error('[self-tests] failed', e); }
    })();
  </script>
</body>
</html>
